# ちょびリッチ案件取得システム ─ わかりやすい仕様書（非エンジニア向け）

## 1. このシステムでやりたいこと

- ポイントサイト **「ちょびリッチ」** に載っている広告案件（アプリ・ショッピングなど）を自動でチェック。
- 新しく出た案件・内容が変わった案件・終了した案件をすぐ見つけて、比較検索サイト **ポイ速** に反映する。
- まずは **ちょびリッチ** だけで仕組みを完成させ、あとで他のサイトにも広げる。

---

## 2. 仕組みの流れ（ざっくり）

1. **決まった時間** にロボット（プログラム）が動き出す。
2. ちょびリッチのページを開き、案件リストを読み取る。
3. 前回と比べて「増えた・変わった・消えた」案件を判定。
4. 見つけた差分を **データベースに保存**。（※通常は通知なし／エラー時のみ Google Chat に通知）
5. バックアップを取り、古いデータは自動で整理。

> ### どこで動く？
>
> - **サーバー**：インターネット上の専用パソコン（VPS）
> - **実行管理**：GitHub のタイマー機能で「いつ動くか」を設定

---

## 3. スクレイピングURLの管理

- 取得に使うのは「こちらで指定した *カテゴリごとの URL*」のみ。
- **新しいカテゴリ URL** が追加された場合は、事前に相談してから設定ファイルへ追加。
- URL 一覧は `config/targets/chobirich_urls.yml` に管理。

---

## 4. いつ動く？（スケジュール）

**スケジュール一覧（表をリスト形式に変更）**

- **差分取得** — 毎日 04:00 / 11:00 / 15:00 / 19:00（新着・更新をすぐ反映）
- **フル取得** — サイトごとに曜日・時刻を分散（例：水曜 02:00＝ちょびリッチ、木曜 02:00＝サイトA、金曜 02:00＝サイトB）〈データの取りこぼしを防ぐ〉

\-------------------------------------------------------------- | ------------ | | 差分取得 | 毎日 04:00 / 11:00 / 15:00 / 19:00                                  | 新着・更新をすぐ反映   | | フル取得 | **サイトごとに曜日・時刻を分散**（例：水曜 02:00＝ちょびリッチ、木曜 02:00＝サイトA、金曜 02:00＝サイトB） | データの取りこぼしを防ぐ |

---

## 5. どんなデータを集める？

**取得する主なフィールド**

1. **案件URL** — [https://www.chobirich.com/ad\_details/36796/（広告詳細ページのユニークキー）](https://www.chobirich.com/ad_details/36796/（広告詳細ページのユニークキー）)
2. **案件名** — ○○アプリDL（広告タイトル）
3. **還元ポイント (pt)** — 800pt（サイト表示のまま取得）
4. **カテゴリ** — アプリ（ショッピング等を区分）
5. **対応端末** — All / iOS / Android / iOS/Android（表示されるデバイス）
6. **取得日時** — 2025-08-04 11:00（取得タイムスタンプ）

**対応端末の分類ルール**

- **All** → *PC 環境* で取得した案件（スマホ・PC 両対応を含む）※UI表示は「すべて」
- **iOS** → *iOS 環境* で取得したスマホアプリ案件
- **Android** → *Android 環境* で取得したスマホアプリ案件
- **iOS/Android** → 両OS対応のスマホアプリ案件 ※UI表示は「スマホ」

### 還元ポイントの表示ルール（ポイ速側）

1. **円換算表示を基本**
   - ポイント数 × "サイトごとの換算レート" を計算し、**円** で表示。
   - 例: ちょびリッチは **2pt = 1円** → 800pt = 400円 相当。
2. **% 案件はそのまま % 表示**
   - 例: 「5% 還元」のように % 単位で示される広告は換算せずそのまま表示。
3. **換算レートはサイト別に管理**
   - `rate_table.yml` 例：
     ```yaml
     chobirich: 0.5     # 2pt=1円 → 0.5円/pt
     moppy: 1           # 1pt=1円
     pointtown: 1       # 1pt=1円
     gendama: 0.01      # 100pt=1円
     ```
4. **表示ラベル例**
   - "400円" / "1,200円" / "5% 還元" など。

※ 円換算は **ポイ速のフロントエンド** で行う想定だが、API レスポンスに両方（pt, yen）が入っていても良い。

---

### 過去7日間の最高額表示ロジック（ポイ速 UI）

- **目的**: 検索結果の最上部に「過去7日間でもっとも高かった還元額（円換算 or ％）をハイライト表示**することで、ユーザーが最高条件をひと目で把握できるようにする。**
- **データソース**: 現行データベース + 直近 7 日分のバックアップ (`/backup/hot/YYYY-MM-DD/`).
- **算出手順**
  1. キーワードが入力されたら、まず **本番インデックス** を検索（通常の結果一覧）。
  2. 同じキーワードで **過去 7 日分の JSON** を順次検索（日単位インメモリ読み込み）。
  3. 検索ヒットした案件のうち、還元値を以下のルールで比較し **最大値** を取得。
     - 円表示案件 → **円換算値**（ポイント × 換算レート）
     - ％案件 → **％値**
     - 異種比較は行わず、**円同士 or ％同士** のみで比較。（片方しか存在しない場合はそのまま採用）
  4. 最大値が見つかったら「サイト名・還元値・日付」を UI コンポーネントに渡し、黄色帯で表示。
- **UI 表記例**（円換算）: `199810pt → 99,905円` の場合 → **99,905円 ちょびリッチ 2025/8/3に記録**
- **キャッシュ**: 同一キーワードの再検索では 1 時間メモリキャッシュを使用し、ファイル I/O を削減。

---

## 6. PC・スマホで表示が違う理由 PC・スマホで表示が違う理由

- **ちょびリッチのスマホアプリ案件** は、アクセスする端末によって見える案件が変わる（PCではそもそも表示されない）。
- そのため **スマホアプリ案件のカテゴリ** に限り、ロボットは
  1. **iPhone のふり**（iOS User‑Agent）
  2. **Android のふり**（Android User‑Agent） の 2 回アクセスしてデータを取得する。
- **スマホアプリ案件以外**（ショッピング・サービスなど）は通常の PC アクセスで取得する。

---

## 7. データの置き場所と安全管理

> **ポイント**：シンプルな JSON ファイル形式で管理。Git によるバージョン管理と Vercel CDN で高速配信。

- **メイン保管** – JSON ファイル形式

  - `public/search-data.json`（2MB、3,644件の検索データ）
  - Git によるバージョン管理でデータ保護
  - Vercel CDN による高速配信（グローバル展開）

- **バックアップ（予備コピー）**

  1. **ホットバックアップ：直近 7 日分**
     - 置き場所：VPS の追加ブロックストレージ `/backup/hot/YYYY-MM-DD/`
     - 役割：誤更新や取りこぼしを“すぐ”戻せる。
     - 自動ローテーション：`find /backup/hot -mtime +7 -delete` を日次 cron で実行。
  2. **アーカイブ：それより古い分**
     - 毎月 1 日に前月分を `tar.gz` 圧縮 → `/backup/archive/YYYY-MM.tgz` に移動
     - 役割：数か月〜数年後に分析したくなったとき用。

- **VPS スナップショット（最終保険）**

  - 週 1 回、自動スナップショットを取得。
  - VPS 故障時は *新規インスタンス + スナップショット復元* で数十分以内に回復。

- **復元手順（例）**

  1. Git リポジトリから最新版を取得
  2. `scrapers/data/chobirich_production_complete_v3.json` を復元
  3. `node scrapers/convert_v3_to_search_data.js` でデータ再生成
  4. Git push で Vercel に自動デプロイ

- **コスト試算**

  - 追加ブロックストレージ 50 GB：月 ¥500〜¥1,000 程度（事業者により変動）
  - スナップショット：保持 2 世代でも月 ¥0〜¥200 程度

---

### ポイ速本体・スクレイピングシステムの保護（最重要）

| 対象                      | 保管方法 | 復旧方法 |
| ----------------------- | ---- | ---- |
| **ポイ速・スクレイピングシステム保護方法** |      |      |

- **ポイ速のコンテンツ**: GitHub でバージョン管理し、週1回 ZIP を `/backup/site_zip/` にミラー。復旧時は `git clone` または ZIP 展開で即復旧。
- **スクレイピングコード**: GitHub Private Repo `poisoku‑scrapers`。特定タグ (`chobirich-v1.2.3`) をチェックアウトし `docker compose up` で再稼働。
- **CI/CD 設定**: リポジトリ内に保持。必要バージョンの YAML を復元して再 Push。
- **Docker イメージ**: GitHub Container Registry に保持し、月1で tar を `/backup/docker_images/` に保存。復旧は `docker pull` または `docker load -i`。
- **Supabase スキーマ**: `schema.sql` を Git 管理し、月1で export。復旧は `psql -f schema.sql`。

---

## 8. エラーが起きたら？ エラーが起きたら？

**エラー処理ルール**

- **軽微な読み込み失敗**: 2回まで自動再試行（5秒間隔）
- **連続5回失敗**: ジョブを中断し、管理者に *Google Chat* でアラート
- **重大エラー（ログイン必須など）**: 即時中断＋Google Chat 通知

\--------------- | ------------------------------------- | | 軽微な読み込み失敗       | 2回まで自動再試行（5秒間隔）                       | | **連続5回失敗**      | その回の処理を中断し、管理者に **Google Chat** でアラート | | 重大エラー（ログイン必須など） | 即時中断＋Google Chat 通知                   |

---

## 9. サイト側への配慮（マナー）

**サイト側への配慮（マナー）**

- **開発中**: データ取得状況・短時間大量アクセスの制限を観察しながら、適切なアクセス回数・User‑Agent・IP 構成を段階的に設定（`config/rate_limit.yml` に記録）。
- **本番稼働**: テスト結果を踏まえ、最終値を確定して本番中は変更しない方針。

\-------- | --------------------------------------------------------------------------------------------- | | **開発中**  | データ取得状況・短時間大量アクセスの制限を観察しながら、適切なアクセス回数・User‑Agent・IP 構成を段階的に設定する。（`config/rate_limit.yml` に記録） | | **本番稼働** | テスト結果を踏まえ、最終値を確定して稼働中は変更しない方針。                                                                |

> *例*: 1分60回上限、スマホ固定 UA、固定IP など —— 実際のサイト制限に応じて確定。

---

## 10. 誰が何を見る？

**役割と確認内容**

- **自動システム**: 取得・保存まで全自動。エラー時のみ通知。
- **管理者（あなた）**: *Google Chat* のエラー通知を確認し、必要に応じて開発担当に依頼。
- **開発担当**: エラー発生時のログ調査と修正。

\-------- | ----------------------------------------- | | 自動システム   | 取得・保存まで全自動。エラー時のみ通知                       | | 管理者（あなた） | **Google Chat 通知**（エラー内容）を確認し、必要なら開発担当に依頼 | | 開発担当     | エラー発生時のログ調査と修正                            |

---

## 11. 将来どう広げる？

1. **ちょびリッチで安定稼働** を確認。
2. 他のポイントサイト用に「取得ルール（YAMLファイル）」を追加するだけで使える仕組みにする。
3. **全カテゴリを同時に対応**（アプリ・ショッピング・サービスなど）し、横展開を加速。

---

## 12. バージョン管理ルール

**バージョン管理ルール**

- **リポジトリ**: GitHub private repo `poisoku-scrapers`
- **ブランチ方針**: `main`（本番リリース） / `dev`（統合テスト） / `feat/*`（個別機能）
- **タグ命名**: `chobirich-vX.Y.Z` 形式で *スパイダ単位* に付与
- **リリースノート**: `docs/release_notes/` に Markdown で保管し、変更点・影響範囲・ロールバック手順を必ず記載

> **目的**: いつのコードでスクレイピングしたか後から追えるようにする＋不具合時の迅速なロールバック。

\------- | ------------------------------------------------------------ | | リポジトリ   | GitHub private repo `poisoku-scrapers`                       | | ブランチ方針  | `main`（本番リリース） / `dev`（統合テスト） / `feat/*`（個別機能）               | | タグ命名    | `chobirich-vX.Y.Z` 形式で **スパイダ単位** に付与                        | | リリースノート | `docs/release_notes/` に Markdown で保管し、変更点・影響範囲・ロールバック手順を必ず記載 |

> **目的**: いつのコードでスクレイピングしたか後から追えるようにする＋不具合時の迅速なロールバック。

---

## 13. テスト反映ポリシー（ポイ速連携）

- **最新データを即時公開**\
  取得ジョブが完了するたびに、取得した案件データをそのままポイ速の検索インデックスへ反映。ステージング環境やテストバッジ表示は行わず、**本番インデックスのみを運用**。

- **モデル変更時の手動チェック**\
  取得スキーマや換算ロジックを変更する場合は、反映前に数キーワードを検索してレイアウト崩れや値の異常がないことを確認。

- **ロールバック手順**\
  不具合が出た場合は GitHub の前バージョン（タグまたはコミット）を即時デプロイして復旧。

---

## 14. コーディング合意フロー（ヴァイブコーディング）

1. **提案フェーズ**\
   開発担当は *ClaudeCode チャット* 内で「これから書く／変更するコード」の概要・対象ファイル・目的を説明。

2. **承認フェーズ**\
   あなた（管理者）がチャット上で **OK** を返したら実装開始。**承認なしでのコミットや PR 作成は禁止**。

3. **実装 & シェア**\
   完了したコードの diff または主要部分を ClaudeCode チャットに貼り付け、動作結果も報告。

4. **最終確認 & マージ**\
   内容に問題がなければ管理者が GitHub で Merge / デプロイを実施。

> **外部通知ツール（Google Chat など）は使用せず**、すべてのやり取りと合意をヴァイブコーディング（ClaudeCode チャット）内で完結させる。

---

### まとめ

- 定期取得 → 差分判定 → 保存・バックアップ の流れは維持。
- **バージョン管理・テスト反映・合意フロー** を明文化し、開発中の混乱とリスクを最小化。
- 他に「これも入れておくと安心」という項目があれば教えてください！

