#!/usr/bin/env node

require('dotenv').config();
const puppeteer = require('puppeteer');
const fs = require('fs').promises;
const path = require('path');

/**
 * „Éù„Ç§„É≥„Éà„Ç§„É≥„Ç´„É†Web„Çπ„ÇØ„É¨„Ç§„Éë„ÉºÔºà„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥‰øÆÊ≠£ÁâàÔºâ
 * 2„Éö„Éº„Ç∏ÁõÆ‰ª•Èôç„ÅÆÂèñÂæóÂïèÈ°å„ÇíÊ†πÊú¨Ëß£Ê±∫
 */
class PointIncomeWebScraperFixed {
  constructor() {
    this.browser = null;
    this.results = [];
    this.stats = this.initializeStats();
    this.config = this.getConfig();
    this.categories = this.initializeCategories();
    this.seenCampaignIds = new Set();
  }

  initializeStats() {
    return {
      startTime: null,
      endTime: null,
      categoriesProcessed: 0,
      pagesProcessed: 0,
      duplicatesSkipped: 0,
      paginationSuccesses: 0,
      paginationFailures: 0,
      errors: [],
      categoryBreakdown: {},
      paginationMethods: {
        direct_url: 0,
        ajax_success: 0,
        ajax_retry: 0,
        fallback_used: 0
      }
    };
  }

  getConfig() {
    return {
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1920, height: 1080 },
      timeout: 45000,
      pageWaitTime: 3000,
      maxRetriesPerCategory: 3,
      maxPagesPerCategory: 999,
      browserRestartInterval: 8,
      browserStartupWait: 2000,
      pageLoadWait: 5000,
      
      // ÊîπËâØ„Åï„Çå„Åü„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
      paginationWaitTime: 20000,
      paginationCheckInterval: 1000,
      maxPaginationRetries: 3,
      ajaxWaitTime: 8000,
      domStabilityWait: 2000
    };
  }

  initializeCategories() {
    // ÂïèÈ°å„Åå„ÅÇ„Å£„Åü„Ç´„ÉÜ„Ç¥„É™„ÇíÂÑ™ÂÖàÁöÑ„Å´„ÉÜ„Çπ„Éà
    const testCategories = [161, 179, 75, 258, 177];
    
    const categories = {};
    testCategories.forEach(id => {
      categories[`test_${id}`] = {
        id,
        name: `„ÉÜ„Çπ„Éà„Ç´„ÉÜ„Ç¥„É™${id}`,
        url: `https://pointi.jp/list.php?category=${id}`,
        type: id >= 160 ? 'shopping' : 'service'
      };
    });

    return categories;
  }

  async initializeBrowser() {
    if (this.browser) {
      try {
        await this.browser.close();
      } catch (error) {
        console.log('‚ö†Ô∏è „Éñ„É©„Ç¶„Ç∂„ÇØ„É≠„Éº„Ç∫„Ç®„É©„Éº:', error.message);
      }
    }

    console.log('üîÑ Êñ∞„Åó„ÅÑ„Éñ„É©„Ç¶„Ç∂„Ç§„É≥„Çπ„Çø„É≥„ÇπËµ∑Âãï‰∏≠...');
    this.browser = await puppeteer.launch({
      headless: false,  // „Éá„Éê„ÉÉ„Ç∞„ÅÆ„Åü„ÇÅÂèØË¶ñÂåñ
      devtools: false,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-web-security',
        '--disable-blink-features=AutomationControlled',
        '--disable-features=VizDisplayCompositor'
      ]
    });
    
    await new Promise(resolve => setTimeout(resolve, this.config.browserStartupWait));
  }

  async execute() {
    console.log('üéØ „Éù„Ç§„É≥„Éà„Ç§„É≥„Ç´„É†Web„Çπ„ÇØ„É¨„Ç§„Éî„É≥„Ç∞ÈñãÂßãÔºà„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥‰øÆÊ≠£ÁâàÔºâ');
    console.log('='.repeat(70));
    console.log(`üìä ÂØæË±°„Ç´„ÉÜ„Ç¥„É™Êï∞: ${Object.keys(this.categories).length}`);

    this.stats.startTime = new Date();

    try {
      await this.initializeBrowser();
      
      let categoryIndex = 0;
      for (const [categoryKey, categoryConfig] of Object.entries(this.categories)) {
        await this.processCategory(categoryKey, categoryConfig);
        
        categoryIndex++;
        if (categoryIndex % this.config.browserRestartInterval === 0) {
          console.log(`üîÑ ÂÆöÊúü„Éñ„É©„Ç¶„Ç∂ÂÜçËµ∑Âãï (${categoryIndex}„Ç´„ÉÜ„Ç¥„É™Âá¶ÁêÜÂÆå‰∫Ü)`);
          await this.initializeBrowser();
        }
        
        await new Promise(resolve => setTimeout(resolve, 2000));
      }

      this.stats.endTime = new Date();
      await this.generateReport();
      
    } catch (error) {
      console.error('üí• ÂÆüË°å„Ç®„É©„Éº:', error);
      this.stats.errors.push({
        phase: 'execution',
        error: error.message
      });
    } finally {
      if (this.browser) {
        await this.browser.close();
      }
    }
  }

  async processCategory(categoryKey, categoryConfig) {
    console.log(`\nüìÇ ${categoryConfig.type.toUpperCase()}: ${categoryConfig.name}`);

    const categoryResults = [];
    let retryCount = 0;

    while (retryCount < this.config.maxRetriesPerCategory) {
      let page = null;
      try {
        if (!this.browser || !this.browser.isConnected()) {
          console.log('‚ö†Ô∏è „Éñ„É©„Ç¶„Ç∂Êé•Á∂öÂ§±Âäπ„ÄÅÂÜçÂàùÊúüÂåñ‰∏≠...');
          await this.initializeBrowser();
        }

        page = await this.browser.newPage();
        await page.setUserAgent(this.config.userAgent);
        await page.setViewport(this.config.viewport);

        // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁõ£Ë¶ñÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
        page.on('response', response => {
          if (response.url().includes('list.php') && response.status() === 200) {
            console.log(`      üåê AJAXÂøúÁ≠î: ${response.url()}`);
          }
        });

        await page.goto(categoryConfig.url, {
          waitUntil: 'networkidle2',
          timeout: this.config.timeout
        });
        
        await new Promise(resolve => setTimeout(resolve, this.config.pageLoadWait));
        
        let currentPage = 1;
        let hasNextPage = true;
        let consecutiveFailures = 0;

        while (hasNextPage && currentPage <= this.config.maxPagesPerCategory && consecutiveFailures < 3) {
          console.log(`   üìÑ „Éö„Éº„Ç∏${currentPage}Âá¶ÁêÜ‰∏≠...`);

          const campaigns = await this.extractCampaigns(page, categoryConfig);
          
          let newCampaigns = 0;
          campaigns.forEach(campaign => {
            if (!this.seenCampaignIds.has(campaign.id)) {
              this.seenCampaignIds.add(campaign.id);
              categoryResults.push(campaign);
              this.results.push(campaign);
              newCampaigns++;
            } else {
              this.stats.duplicatesSkipped++;
            }
          });

          console.log(`      ‚úÖ ${campaigns.length}‰ª∂ÂèñÂæó (Êñ∞Ë¶è: ${newCampaigns}‰ª∂)`);

          // ÊîπËâØ„Åï„Çå„Åü„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÂÆüË°å
          const paginationResult = await this.navigateToNextPageImproved(page, currentPage);
          
          if (paginationResult.success) {
            currentPage++;
            this.stats.pagesProcessed++;
            this.stats.paginationSuccesses++;
            consecutiveFailures = 0;
            
            // ÊñπÊ≥ïÂà•Áµ±Ë®à
            this.stats.paginationMethods[paginationResult.method]++;
            
            await new Promise(resolve => setTimeout(resolve, this.config.pageWaitTime));
          } else {
            console.log(`      ‚ùå „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Â§±Êïó: ${paginationResult.reason}`);
            this.stats.paginationFailures++;
            
            if (paginationResult.reason === 'no_next_button') {
              hasNextPage = false;
            } else {
              consecutiveFailures++;
              if (consecutiveFailures < 3) {
                console.log(`      üîÑ „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„É™„Éà„É©„Ç§ (${consecutiveFailures}/3)`);
                await new Promise(resolve => setTimeout(resolve, 5000));
              } else {
                hasNextPage = false;
              }
            }
          }
        }

        if (page) {
          await page.close();
        }
        break;

      } catch (error) {
        retryCount++;
        console.log(`   ‚ö†Ô∏è „Ç®„É©„Éº („É™„Éà„É©„Ç§ ${retryCount}/${this.config.maxRetriesPerCategory}): ${error.message}`);
        
        if (page) {
          try {
            await page.close();
          } catch (closeError) {
            console.log('      ‚ö†Ô∏è „Éö„Éº„Ç∏„ÇØ„É≠„Éº„Ç∫„Ç®„É©„Éº:', closeError.message);
          }
        }
        
        if (error.message.includes('Protocol error') || error.message.includes('Connection closed')) {
          console.log('   üîÑ Êé•Á∂ö„Ç®„É©„Éº„ÅÆ„Åü„ÇÅ„Éñ„É©„Ç¶„Ç∂ÂÜçÂàùÊúüÂåñ‰∏≠...');
          await this.initializeBrowser();
        }
        
        if (retryCount >= this.config.maxRetriesPerCategory) {
          this.stats.errors.push({
            category: categoryKey,
            error: error.message
          });
        }
        
        await new Promise(resolve => setTimeout(resolve, 3000));
      }
    }

    this.stats.categoriesProcessed++;
    this.stats.categoryBreakdown[categoryKey] = categoryResults.length;
    console.log(`   üìä „Ç´„ÉÜ„Ç¥„É™ÂêàË®à: ${categoryResults.length}‰ª∂`);
  }

  async extractCampaigns(page, categoryConfig) {
    return await page.evaluate((config) => {
      const campaigns = [];
      
      function normalizePointsForPointIncome(pointsText) {
        if (!pointsText) return '';
        
        const percentageMatch = pointsText.match(/Ë≥ºÂÖ•ÈáëÈ°ç„ÅÆ(\d+(?:\.\d+)?)%/);
        if (percentageMatch) {
          return `${percentageMatch[1]}%`;
        }
        
        const pointMatch = pointsText.match(/(\d+(?:,\d+)?)pt/);
        if (pointMatch) {
          const points = parseInt(pointMatch[1].replace(/,/g, ''));
          const yen = Math.floor(points / 10);
          return `${yen.toLocaleString()}ÂÜÜ`;
        }
        
        return pointsText;
      }
      
      const campaignElements = document.querySelectorAll('.box_ad');
      
      campaignElements.forEach((element, index) => {
        try {
          const titleElement = element.querySelector('.title_list');
          const title = titleElement ? titleElement.textContent.trim() : '';
          
          const linkElement = element.querySelector('a[href*="./ad/"]');
          const relativeUrl = linkElement ? linkElement.getAttribute('href') : '';
          
          const pointElement = element.querySelector('.list_pt_box .list_pt');
          let points = pointElement ? pointElement.textContent.trim() : '';
          points = normalizePointsForPointIncome(points);
          
          let id = '';
          if (relativeUrl) {
            const idMatch = relativeUrl.match(/\/ad\/(\d+)\//); 
            id = idMatch ? idMatch[1] : `gen_${Date.now()}_${index}`;
          } else {
            id = `gen_${Date.now()}_${index}`;
          }
          
          let absoluteUrl = '';
          if (relativeUrl) {
            absoluteUrl = relativeUrl.startsWith('http') 
              ? relativeUrl 
              : `https://pointi.jp${relativeUrl.replace('./', '/')}`;
          }

          if (title && id) {
            campaigns.push({
              id,
              title,
              url: absoluteUrl,
              points,
              device: '„Åô„Åπ„Å¶',
              category_id: config ? config.id : null,
              category_type: config ? config.type : null,
              timestamp: new Date().toISOString()
            });
          }
        } catch (e) {
          console.error('Campaign extraction error:', e);
        }
      });

      return campaigns;
    }, categoryConfig);
  }

  // Â§ßÂπÖ„Å´ÊîπËâØ„Åï„Çå„Åü„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Âá¶ÁêÜ
  async navigateToNextPageImproved(page, currentPage) {
    try {
      console.log(`      üîç „Éö„Éº„Ç∏${currentPage} ‚Üí „Éö„Éº„Ç∏${currentPage + 1} „Å∏„ÅÆÈÅ∑Áßª„ÇíË©¶Ë°å`);
      
      // 1. Ê¨°„Å∏„Éú„Çø„É≥„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæó
      const nextButtonInfo = await this.getDetailedNextButtonInfo(page);
      
      if (!nextButtonInfo.found) {
        return { success: false, reason: 'no_next_button', method: 'none' };
      }
      
      console.log(`      üìã Ê¨°„Å∏„Éú„Çø„É≥ÊÉÖÂ†±: ${nextButtonInfo.text} („Éö„Éº„Ç∏${nextButtonInfo.targetPage})`);
      
      // 2. ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏Áä∂ÊÖã„ÇíË®òÈå≤
      const beforeState = await this.getPageState(page);
      console.log(`      üìä ÈÅ∑ÁßªÂâç: ${beforeState.count}‰ª∂ (ÊúÄÂàù: "${beforeState.firstTitle?.substring(0, 30)}...")`);
      
      // 3. Ë§áÊï∞„ÅÆÊñπÊ≥ï„Åß„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„ÇíË©¶Ë°å
      let result = null;
      
      // ÊñπÊ≥ï1: Áõ¥Êé•URL„Ç¢„ÇØ„Çª„ÇπÔºàÊúÄ„ÇÇÁ¢∫ÂÆüÔºâ
      if (nextButtonInfo.directUrl) {
        result = await this.tryDirectUrlPagination(page, nextButtonInfo.directUrl, beforeState);
        if (result.success) return result;
      }
      
      // ÊñπÊ≥ï2: ÊîπËâØ„Åï„Çå„ÅüAJAX„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥
      if (nextButtonInfo.onclick) {
        result = await this.tryImprovedAjaxPagination(page, nextButtonInfo, beforeState, currentPage + 1);
        if (result.success) return result;
      }
      
      // ÊñπÊ≥ï3: „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ - Ë¶ÅÁ¥†„ÇØ„É™„ÉÉ„ÇØ
      result = await this.tryElementClickPagination(page, beforeState);
      if (result.success) return result;
      
      return { success: false, reason: 'all_methods_failed', method: 'none' };
      
    } catch (error) {
      console.log(`      ‚ö†Ô∏è „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥‰æãÂ§ñ: ${error.message}`);
      return { success: false, reason: 'exception', method: 'none' };
    }
  }

  async getDetailedNextButtonInfo(page) {
    return await page.evaluate(() => {
      const PAGE_NUMBER_PATTERN = /tab_select\([^,]+,\s*\d+,\s*\d+,\s*(\d+)\)/;
      
      // „ÄåÊ¨°„Å∏„Äç„Éú„Çø„É≥„ÇíÊ§úÁ¥¢
      const links = Array.from(document.querySelectorAll('a[onclick*="tab_select"]'));
      
      for (const link of links) {
        const text = link.textContent.trim();
        if (text.includes('Ê¨°„Å∏') || text === 'Ê¨°„Å∏>') {
          const onclick = link.getAttribute('onclick');
          const pageMatch = onclick.match(PAGE_NUMBER_PATTERN);
          const targetPage = pageMatch ? parseInt(pageMatch[1]) : null;
          
          // Áõ¥Êé•URLÂΩ¢Âºè„ÇíÁîüÊàêÔºàÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
          let directUrl = null;
          const currentUrl = new URL(window.location.href);
          if (targetPage && currentUrl.searchParams.get('category')) {
            const categoryId = currentUrl.searchParams.get('category');
            directUrl = `https://pointi.jp/list.php?category=${categoryId}&page=${targetPage}`;
          }
          
          return {
            found: true,
            onclick: onclick,
            text: text,
            targetPage: targetPage,
            element: link,
            directUrl: directUrl
          };
        }
      }
      
      return { found: false };
    });
  }

  // ÊñπÊ≥ï1: Áõ¥Êé•URL„Ç¢„ÇØ„Çª„Çπ
  async tryDirectUrlPagination(page, directUrl, beforeState) {
    try {
      console.log(`      üîó Áõ¥Êé•URLÈÅ∑Áßª: ${directUrl}`);
      
      await page.goto(directUrl, {
        waitUntil: 'networkidle2',
        timeout: this.config.timeout
      });
      
      await new Promise(resolve => setTimeout(resolve, this.config.domStabilityWait));
      
      const afterState = await this.getPageState(page);
      
      if (afterState.count > 0 && afterState.firstTitle !== beforeState.firstTitle) {
        console.log(`      ‚úÖ Áõ¥Êé•URLÈÅ∑ÁßªÊàêÂäü: ${afterState.count}‰ª∂`);
        return { success: true, method: 'direct_url' };
      }
      
      console.log(`      ‚ùå Áõ¥Êé•URLÈÅ∑ÁßªÂ§±Êïó: ${afterState.count}‰ª∂`);
      return { success: false, method: 'direct_url' };
      
    } catch (error) {
      console.log(`      ‚ùå Áõ¥Êé•URL‰æãÂ§ñ: ${error.message}`);
      return { success: false, method: 'direct_url' };
    }
  }

  // ÊñπÊ≥ï2: ÊîπËâØ„Åï„Çå„ÅüAJAX„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥
  async tryImprovedAjaxPagination(page, buttonInfo, beforeState, targetPage) {
    try {
      console.log(`      üñ±Ô∏è AJAXÈÅ∑ÁßªÂÆüË°å: ${buttonInfo.onclick}`);
      
      // „Éë„É©„É°„Éº„Çø„ÇíËß£Êûê
      const paramMatch = buttonInfo.onclick.match(/tab_select\('([^']+)',\s*(\d+),\s*(\d+),\s*(\d+)\)/);
      if (!paramMatch) {
        return { success: false, method: 'ajax_failed' };
      }
      
      const [, tab, param2, param3, param4] = paramMatch;
      
      // Ë§áÊï∞Âõû„É™„Éà„É©„Ç§„ÅßAJAXÂÆüË°å
      for (let attempt = 1; attempt <= this.config.maxPaginationRetries; attempt++) {
        console.log(`      üîÑ AJAXÂÆüË°å (Ë©¶Ë°å ${attempt}/${this.config.maxPaginationRetries})`);
        
        // tab_selectÈñ¢Êï∞„ÇíÂÆüË°å
        const executeResult = await page.evaluate((tab, p2, p3, targetPage) => {
          if (typeof window.tab_select === 'function') {
            console.log(`tab_selectÂÆüË°å: ('${tab}', ${p2}, ${p3}, ${targetPage})`);
            window.tab_select(tab, parseInt(p2), parseInt(p3), targetPage);
            return true;
          }
          return false;
        }, tab, parseInt(param2), parseInt(param3), targetPage);
        
        if (!executeResult) {
          console.log(`      ‚ùå tab_selectÈñ¢Êï∞„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
          return { success: false, method: 'ajax_failed' };
        }
        
        // AJAXÂÆå‰∫Ü„ÇíÂæÖÊ©üÔºàÊÆµÈöéÁöÑ„ÉÅ„Çß„ÉÉ„ÇØÔºâ
        await new Promise(resolve => setTimeout(resolve, this.config.ajaxWaitTime));
        
        // DOMÊõ¥Êñ∞„Çí„Çà„ÇäÈï∑ÊúüÈñìÁõ£Ë¶ñ
        const contentChanged = await this.waitForContentChangeImproved(page, beforeState);
        
        if (contentChanged) {
          const afterState = await this.getPageState(page);
          if (afterState.count > 0) {
            console.log(`      ‚úÖ AJAXÈÅ∑ÁßªÊàêÂäü (Ë©¶Ë°å ${attempt}): ${afterState.count}‰ª∂`);
            return { 
              success: true, 
              method: attempt === 1 ? 'ajax_success' : 'ajax_retry' 
            };
          }
        }
        
        if (attempt < this.config.maxPaginationRetries) {
          console.log(`      ‚è≥ AJAXÈÅ∑ÁßªÂ§±Êïó„ÄÅÂÜçË©¶Ë°å„Åæ„ÅßÂæÖÊ©ü...`);
          await new Promise(resolve => setTimeout(resolve, 3000));
        }
      }
      
      return { success: false, method: 'ajax_failed' };
      
    } catch (error) {
      console.log(`      ‚ùå AJAX‰æãÂ§ñ: ${error.message}`);
      return { success: false, method: 'ajax_failed' };
    }
  }

  // ÊñπÊ≥ï3: Ë¶ÅÁ¥†„ÇØ„É™„ÉÉ„ÇØ
  async tryElementClickPagination(page, beforeState) {
    try {
      console.log(`      üñ±Ô∏è Ë¶ÅÁ¥†„ÇØ„É™„ÉÉ„ÇØÈÅ∑Áßª`);
      
      const clickResult = await page.evaluate(() => {
        const nextButton = Array.from(document.querySelectorAll('a[onclick*="tab_select"]'))
          .find(link => link.textContent.trim().includes('Ê¨°„Å∏'));
        
        if (nextButton) {
          nextButton.click();
          return true;
        }
        return false;
      });
      
      if (!clickResult) {
        return { success: false, method: 'click_failed' };
      }
      
      await new Promise(resolve => setTimeout(resolve, this.config.ajaxWaitTime));
      
      const contentChanged = await this.waitForContentChangeImproved(page, beforeState);
      const afterState = await this.getPageState(page);
      
      if (contentChanged && afterState.count > 0) {
        console.log(`      ‚úÖ „ÇØ„É™„ÉÉ„ÇØÈÅ∑ÁßªÊàêÂäü: ${afterState.count}‰ª∂`);
        return { success: true, method: 'fallback_used' };
      }
      
      return { success: false, method: 'click_failed' };
      
    } catch (error) {
      console.log(`      ‚ùå „ÇØ„É™„ÉÉ„ÇØ‰æãÂ§ñ: ${error.message}`);
      return { success: false, method: 'click_failed' };
    }
  }

  async getPageState(page) {
    return await page.evaluate(() => {
      const firstAd = document.querySelector('.box_ad .title_list');
      const allAds = document.querySelectorAll('.box_ad');
      return {
        firstTitle: firstAd ? firstAd.textContent.trim() : null,
        count: allAds.length,
        bodyLength: document.body.innerHTML.length,
        timestamp: Date.now()
      };
    }).catch(() => ({ firstTitle: null, count: 0, bodyLength: 0, timestamp: Date.now() }));
  }

  // ÊîπËâØ„Åï„Çå„ÅüÂÜÖÂÆπÂ§âÂåñÂæÖÊ©ü
  async waitForContentChangeImproved(page, beforeState) {
    let waitedTime = 0;
    let lastCheckTime = Date.now();
    let stableCount = 0; // ÈÄ£Á∂ö„Åó„Å¶Âêå„ÅòÁä∂ÊÖã„ÅÆÂõûÊï∞
    
    console.log(`      ‚è≥ ÂÜÖÂÆπÂ§âÂåñÂæÖÊ©ü (ÊúÄÂ§ß${this.config.paginationWaitTime/1000}Áßí)`);
    
    while (waitedTime < this.config.paginationWaitTime) {
      await new Promise(resolve => setTimeout(resolve, this.config.paginationCheckInterval));
      waitedTime += this.config.paginationCheckInterval;
      
      const currentState = await this.getPageState(page);
      
      // ÂÜÖÂÆπ„ÅåÂ§âÂåñ„Åó„ÅüÂ†¥Âêà
      if (currentState.firstTitle && 
          currentState.firstTitle !== beforeState.firstTitle && 
          currentState.count > 0) {
        console.log(`      üìù ÂÜÖÂÆπÂ§âÂåñÊ§úÂá∫: "${beforeState.firstTitle?.substring(0, 20)}..." ‚Üí "${currentState.firstTitle.substring(0, 20)}..."`);
        
        // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Á¢∫Ë™çÔºàDOMÂÆâÂÆöÂåñ„ÅÆ„Åü„ÇÅÔºâ
        await new Promise(resolve => setTimeout(resolve, this.config.domStabilityWait));
        const finalState = await this.getPageState(page);
        
        if (finalState.count > 0) {
          return true;
        }
      }
      
      // 0‰ª∂„ÅåÁ∂ö„ÅèÂ†¥Âêà„ÅØÊó©ÊúüÁµÇ‰∫Ü
      if (currentState.count === 0) {
        stableCount++;
        if (stableCount >= 3) {
          console.log(`      ‚ùå 0‰ª∂Áä∂ÊÖã„ÅåÁ∂ôÁ∂ö„ÄÅÊó©ÊúüÁµÇ‰∫Ü`);
          return false;
        }
      } else {
        stableCount = 0;
      }
      
      // ÈÄ≤ÊçóË°®Á§∫
      if (waitedTime % 3000 === 0) {
        console.log(`      ‚åõ ÂæÖÊ©ü‰∏≠... ${waitedTime/1000}s (ÁèæÂú®: ${currentState.count}‰ª∂)`);
      }
    }
    
    console.log(`      ‚è∞ „Çø„Ç§„É†„Ç¢„Ç¶„Éà: ${this.config.paginationWaitTime/1000}ÁßíÁµåÈÅé`);
    return false;
  }

  async generateReport() {
    console.log('\n' + '='.repeat(70));
    console.log('üìä „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥‰øÆÊ≠£Áâà„Çπ„ÇØ„É¨„Ç§„Éî„É≥„Ç∞ÂÆå‰∫Ü„É¨„Éù„Éº„Éà');
    console.log('='.repeat(70));

    const duration = (this.stats.endTime - this.stats.startTime) / 1000 / 60;
    
    console.log(`‚è±Ô∏è ÂÆüË°åÊôÇÈñì: ${duration.toFixed(2)}ÂàÜ`);
    console.log(`üìÇ Âá¶ÁêÜ„Ç´„ÉÜ„Ç¥„É™Êï∞: ${this.stats.categoriesProcessed}/${Object.keys(this.categories).length}`);
    console.log(`üìÑ Âá¶ÁêÜ„Éö„Éº„Ç∏Êï∞: ${this.stats.pagesProcessed}`);
    console.log(`üéØ ÂèñÂæóÊ°à‰ª∂Êï∞: ${this.results.length}`);
    console.log(`üîÅ ÈáçË§á„Çπ„Ç≠„ÉÉ„ÉóÊï∞: ${this.stats.duplicatesSkipped}`);
    
    console.log(`\nüìä „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Áµ±Ë®à:`);
    console.log(`   ‚úÖ ÊàêÂäü: ${this.stats.paginationSuccesses}Âõû`);
    console.log(`   ‚ùå Â§±Êïó: ${this.stats.paginationFailures}Âõû`);
    console.log(`   üìà ÊàêÂäüÁéá: ${((this.stats.paginationSuccesses / (this.stats.paginationSuccesses + this.stats.paginationFailures)) * 100).toFixed(1)}%`);
    
    console.log(`\nüõ†Ô∏è „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÊñπÊ≥ïÂà•Áµ±Ë®à:`);
    console.log(`   üîó Áõ¥Êé•URL: ${this.stats.paginationMethods.direct_url}Âõû`);
    console.log(`   ‚ö° AJAXÊàêÂäü: ${this.stats.paginationMethods.ajax_success}Âõû`);
    console.log(`   üîÑ AJAX„É™„Éà„É©„Ç§: ${this.stats.paginationMethods.ajax_retry}Âõû`);
    console.log(`   üÜò „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ${this.stats.paginationMethods.fallback_used}Âõû`);
    
    if (this.stats.errors.length > 0) {
      console.log(`\n‚ö†Ô∏è „Ç®„É©„Éº: ${this.stats.errors.length}‰ª∂`);
      this.stats.errors.forEach((error, i) => {
        console.log(`   ${i + 1}. ${error.category || error.phase}: ${error.error}`);
      });
    }

    console.log(`\nüìÇ „Ç´„ÉÜ„Ç¥„É™Âà•ÂèñÂæóÊï∞:`);
    Object.entries(this.stats.categoryBreakdown).forEach(([cat, count]) => {
      console.log(`   ${cat}: ${count}‰ª∂`);
    });

    await this.saveResults();
  }

  async saveResults() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = path.join(__dirname, '../../../data/pointincome', `pointincome_fixed_${timestamp}.json`);
    
    const data = {
      scrape_date: new Date().toISOString(),
      version: 'pagination_fixed_v1',
      stats: this.stats,
      total_campaigns: this.results.length,
      campaigns: this.results
    };

    await fs.writeFile(filename, JSON.stringify(data, null, 2));
    console.log(`\nüíæ „Éá„Éº„Çø‰øùÂ≠òÂÆå‰∫Ü: ${filename}`);
  }
}

if (require.main === module) {
  const scraper = new PointIncomeWebScraperFixed();
  scraper.execute().then(() => {
    console.log('\n‚úÖ ÂÖ®Âá¶ÁêÜÂÆå‰∫Ü');
    process.exit(0);
  }).catch(error => {
    console.error('\nüí• Ëá¥ÂëΩÁöÑ„Ç®„É©„Éº:', error);
    process.exit(1);
  });
}

module.exports = PointIncomeWebScraperFixed;