# ポイ速 ちょびリッチスクレイピングシステム - 最終アーキテクチャ

**最終更新**: 2025-08-07  
**ステータス**: 運用準備完了

## 🎯 採用システム

**方針A: 完全取得のみ - シンプル・確実・100%取得保証**

## 📁 メインシステム構成

### 1. 日次更新システム（推奨実行方法）
```bash
node daily_complete_update.js
```

**内部実行順序**:
1. `complete_chobirich_system_v3.js` - 完全案件取得（45分）
2. `convert_v3_to_search_data.js` - 検索データ変換（1分）
3. `validate_and_fix_point_data.js` - データ検証・修正（30秒）

### 2. 個別システム（開発・デバッグ用）

#### 完全取得システム
- **`complete_chobirich_system_v3.js`** - メインスクレイピングエンジン
  - Web案件: 20カテゴリ × 最大15ページ
  - iOS案件: 21ページ完全スキャン
  - Android案件: 全ページ完全スキャン
  - 取得率: 100% （3,644件）
  - 処理時間: 45分

#### データ処理システム
- **`convert_v3_to_search_data.js`** - v3形式→ポイ速検索形式変換
- **`validate_and_fix_point_data.js`** - データ品質保証・自動修正
- **`fix_device_display.js`** - デバイス表記統一

## 📊 運用仕様

### 処理時間
- **総処理時間**: 約50分
- **取得精度**: 100%
- **更新頻度**: 日次1回（推奨）

### データフロー
```
ちょびリッチサイト
    ↓ (45分)
v3完全取得システム
    ↓ (1分)
検索データ変換
    ↓ (30秒)
データ検証・修正
    ↓ (5分)
Vercel自動デプロイ
    ↓
ポイ速本番環境
```

### 出力ファイル
- `data/chobirich_production_complete_v3.json` - v3生データ（2MB）
- `../public/search-data.json` - ポイ速検索用データ（2MB）
- `../public/search-data-backup.json` - バックアップ

## 🕐 推奨運用スケジュール

### 日次運用
```bash
# crontab設定例
0 2 * * * cd /path/to/scrapers && node daily_complete_update.js
```

### 緊急時手動実行
```bash
# 特定サイトで大幅変動時
cd /Users/kn/poisoku-web/scrapers
node daily_complete_update.js
```

## 🚫 廃止・アーカイブ済みシステム

### 差分取得システム実験
- **場所**: `archive/differential_system_experiment/`
- **廃止理由**: 技術的限界により83.6%の取得漏れ発生
- **実験結果**: 差分システムでは100%取得不可能と判明

## 🔧 技術仕様

### 対象サイト
- **ちょびリッチ**: https://www.chobirich.com/

### 対象案件
- **Web案件**: ショッピング11カテゴリ + サービス9カテゴリ
- **モバイル案件**: iOS/Androidアプリ案件

### 技術的制約
- **Protocol error対策**: 3カテゴリ毎のブラウザ再起動
- **メモリリーク防止**: 定期的なリソース解放
- **アクセス制限**: 適切な間隔でのリクエスト実行

## 📋 品質保証

### データ検証項目
- ポイント数値の桁落ち検出・修正
- デバイス表記の統一（PC→すべて）
- 重複データの排除
- 不正な文字列の除外

### エラー処理
- 自動リトライ機能
- ブラウザクラッシュ対策
- チェックポイント機能（中断・再開対応）

## 🎯 成功指標

- **取得率**: 99%以上
- **処理時間**: 60分以内
- **データ品質**: 自動検証クリア
- **運用安定性**: 週間稼働率95%以上

## 📞 運用サポート

### ログファイル
- `logs/daily_update_YYYY-MM-DD.log` - 実行ログ
- `logs/daily_update_YYYY-MM-DD.json` - 実行結果JSON

### トラブルシューティング
1. **実行失敗時**: ログファイル確認
2. **データ異常時**: `validate_and_fix_point_data.js` 単体実行  
3. **緊急復旧**: バックアップファイルからの復元

---

**このアーキテクチャは差分取得実験の結果を踏まえ、確実性を最優先とした最終形です。**