# 🚀 本番運用スクレイピング実行ガイド

## 概要
ポイントインカムの全案件データをスクレイピングし、ポイ速への反映まで実行する完全なフローです。

## 前提条件確認

### システム要件
- Node.js環境
- Puppeteerの動作環境
- Supabaseアクセス権限
- 十分なディスク容量（約100MB）

### 推定実行時間
- **メインカテゴリ**: 約30-45分（1,043件の案件）
- **モバイルアプリ**: 約15-20分（100件の案件）
- **データベース統合**: 約2-3分
- **検索データ生成**: 約1-2分
- **合計**: 約50-70分

## 実行手順

### ステップ1: メインカテゴリスクレイピング

```bash
cd /Users/kn/poisoku-web/scripts/pointincome
node batch-scraper.js
```

**期待される進行状況:**
```
🎯 ポイントインカム バッチスクレイピング開始
📊 処理対象: 39カテゴリ（バッチサイズ: 12）

🔥 バッチ 1 開始（12カテゴリ）
  ✅ [1/12] EC・ネットショッピング: 116件
  ✅ [2/12] 金融・投資・保険: 89件
  ...
🔄 ブラウザ再起動中...

🔥 バッチ 2 開始（12カテゴリ）
  ...

🎉 バッチスクレイピング完了！
📊 総案件数: 1043件
⏱️ 実行時間: XX分
💾 データ保存: pointincome_batch_final.json
```

### ステップ2: モバイルアプリスクレイピング

```bash
node batch-mobile-scraper.js
```

**期待される進行状況:**
```
📱 ポイントインカム モバイルアプリ バッチスクレイピング開始
📊 バッチサイズ: 20件ずつ処理

📊 スクロール読み込み開始...
  📄 スクロール 1: 20件の案件
  📄 スクロール 2: 40件の案件
  ...
📊 発見された案件: 100件

🔥 バッチ 1 開始（20件）
  ✅ [1/20] [iOS] 金とゴブリンの採掘ゲーム - 3685円
  ✅ [2/20] [Android] 獅子の如く【四季の祝福 購入】 - 2000円
  ...

🎉 モバイルアプリ バッチスクレイピング完了！
📊 総案件数: 100件
📱 デバイス別内訳:
  iOS: 48件
  Android: 42件
  すべて: 10件
💾 データ保存: pointincome_mobile_batch_final.json
```

### ステップ3: データベース統合

```bash
node integrate-to-database.js
```

**期待される進行状況:**
```
🔄 ポイントインカムデータのデータベース統合開始

📂 データファイル読み込み中...
📊 メインカテゴリ: 1043件
📱 モバイルアプリ: 100件
📋 合計案件数: 1143件

📊 カテゴリ別内訳:
  shopping: 116件
  other: 925件
  app: 100件

📤 データベースへ挿入中...
  ✅ 500/1141件挿入完了
  ✅ 1000/1141件挿入完了
  ✅ 1141/1141件挿入完了

🎉 データベース統合完了！
📊 合計 1143件の案件を統合しました
```

### ステップ4: 検索データ再生成

```bash
cd /Users/kn/poisoku-web
node scripts/generate-search-data.js
```

**期待される進行状況:**
```
🚀 静的サイト用検索データ生成開始
📂 データベースからキャンペーンデータを取得中...
✅ 3950件程度のキャンペーンを取得（ポイントインカム1141件含む）
🔍 有効な還元率の案件: 3900件程度

💾 検索データを保存: public/search-data.json
📊 統計情報:
   - 総キャンペーン数: 3950件
   - ファイルサイズ: 1.9MB程度

🎉 検索データ生成完了
```

### ステップ5: 結果確認

```bash
# 獅子の如くの確認
grep -n "獅子の如く" public/search-data.json

# 期待される結果:
# XXXX:      "description": "7/31で終了！獅子の如く【四季の祝福 購入】（Android用）",
# YYYY:      "description": "7/31で終了！獅子の如く【四季の祝福 購入】（iOS用）",

# デバイス別統計確認
echo "iOS案件数: $(grep -c '"device": "iOS"' public/search-data.json)"
echo "Android案件数: $(grep -c '"device": "Android"' public/search-data.json)"

# 期待される結果:
# iOS案件数: 150件程度
# Android案件数: 550件程度
```

### ステップ6: 本番デプロイ

```bash
git add .
git commit -m "Production scraping update - $(date '+%Y%m%d_%H%M')

- Fresh scraping of all PointIncome campaigns
- Updated mobile app campaigns including 獅子の如く
- Total campaigns: ~3950 including latest offers
- Verified search functionality with mobile apps

🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"

git push
```

## 品質確認チェックリスト

### ✅ スクレイピング品質
- [ ] メインカテゴリ: 1000件以上の案件
- [ ] モバイルアプリ: 90件以上の案件
- [ ] 獅子の如く: iOS版・Android版共に存在
- [ ] 還元率: 正確な金額・パーセント表示

### ✅ データベース統合品質
- [ ] 重複除去: 適切に実行
- [ ] カテゴリマッピング: app/shopping/other
- [ ] デバイス分類: iOS/Android/All
- [ ] エラーハンドリング: 制約違反の自動回避

### ✅ 検索データ品質
- [ ] 総案件数: 3900件以上
- [ ] ファイルサイズ: 1.8MB以上
- [ ] 獅子の如く: 検索可能
- [ ] モバイルアプリ: フィルタリング可能

## トラブルシューティング

### よくある問題と解決策

#### 1. スクレイピング中断
```bash
# チェックポイントから再開
ls -la *checkpoint*.json
# 該当ファイルが存在すれば自動的に再開される
```

#### 2. メモリ不足エラー
```bash
# バッチサイズを小さくして再実行
# batch-scraper.js の batchSize を 8 に変更
```

#### 3. 接続エラー
```bash
# レート制限を増やして再実行
# rateLimitMs を 3000 に変更
```

#### 4. データベース制約エラー
- 統合スクリプトが自動的にフォールバック処理を実行
- "other" カテゴリで統合される（正常動作）

## 成功の確認方法

### 1. 技術的確認
- すべてのステップが正常終了
- エラーログに重大なエラーがない
- ファイルサイズが妥当

### 2. 機能確認
1. https://poisoku.jp にアクセス
2. 「獅子の如く」で検索
3. iOS版・Android版が表示される
4. 2000円の還元率が正しく表示される

### 3. データ品質確認
- 最新の案件が含まれている
- 還元率が正確
- デバイスフィルタが機能する

## 定期実行の推奨

- **頻度**: 週1-2回
- **タイミング**: 深夜または早朝
- **監視**: ログファイルの確認
- **アラート**: エラー時の通知設定